{% extends 'base.html' %}

{% block title %}{% if seo %}{{ seo.title }}{% else %}{{ _('resize_title') }} - {{ site_name }}{% endif %}{% endblock %}

{% block header_icon %}üìê{% endblock %}
{% block header_title %}{{ _('resize_title') }}{% endblock %}
{% block header_subtitle %}{{ _('resize_subtitle') }}{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg, #4338ca 0%, #6366f1 100%);
        background-size: 200% 200%;
        animation: gradientShift 15s ease infinite;
    }

    .file-info-bar {
        margin-top: 20px; padding: 16px 20px;
        background: rgba(255,255,255,0.15); backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2); border-radius: 14px;
        display: none; align-items: center; justify-content: space-between;
    }
    .file-info-bar.show { display: flex; }
    .file-info-bar .file-name { font-weight: 600; font-size: 0.95rem; }
    .file-info-bar .file-size { font-size: 0.85rem; color: rgba(255,255,255,0.6); }
    .file-info-bar .change-btn {
        padding: 6px 14px; background: rgba(255,255,255,0.15);
        border: 1px solid rgba(255,255,255,0.2); color: white;
        border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 600;
    }

    /* Size selector */
    .config-section { display: none; margin: 20px 0; }
    .config-section.show { display: block; }
    .config-label { font-weight: 600; font-size: 0.9rem; margin-bottom: 12px; color: rgba(255,255,255,0.8); }

    .size-grid {
        display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;
    }
    .size-option {
        padding: 18px 12px; background: rgba(255,255,255,0.08);
        border: 2px solid rgba(255,255,255,0.15); border-radius: 14px;
        text-align: center; cursor: pointer; transition: all 0.3s;
    }
    .size-option:hover {
        background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.3);
    }
    .size-option.active {
        background: rgba(67,56,202,0.4); border-color: rgba(99,102,241,0.8);
    }
    .size-option .size-name { font-weight: 700; font-size: 1rem; margin-bottom: 4px; }
    .size-option .size-dims { font-size: 0.78rem; color: rgba(255,255,255,0.5); }

    /* Mode selector */
    .mode-grid {
        display: flex; gap: 10px; margin-bottom: 20px;
    }
    .mode-option {
        flex: 1; padding: 14px; background: rgba(255,255,255,0.08);
        border: 2px solid rgba(255,255,255,0.15); border-radius: 12px;
        text-align: center; cursor: pointer; transition: all 0.3s;
    }
    .mode-option:hover { background: rgba(255,255,255,0.15); }
    .mode-option.active {
        background: rgba(67,56,202,0.4); border-color: rgba(99,102,241,0.8);
    }
    .mode-option .mode-icon { font-size: 1.5rem; margin-bottom: 6px; }
    .mode-option .mode-name { font-weight: 700; font-size: 0.85rem; }
    .mode-option .mode-desc { font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 4px; }

    /* Loading */
    .loading-indicator { display: none; text-align: center; padding: 30px; margin-top: 20px; }
    .loading-indicator.show { display: block; }
    .loading-indicator .spinner {
        width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.15);
        border-top-color: #6366f1; border-radius: 50%;
        animation: spin 0.8s linear infinite; margin: 0 auto 14px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 768px) {
        .size-grid { grid-template-columns: repeat(2, 1fr); }
        .mode-grid { flex-direction: column; }
    }
    @media (max-width: 480px) {
        .size-grid { grid-template-columns: 1fr 1fr; }
    }
</style>
{% endblock %}

{% block step_indicator %}
<div class="step-indicator" id="stepIndicator">
    <div class="step active"><div class="step-number">1</div><span class="step-label">{{ _('step_upload') }}</span></div>
    <div class="step-line"></div>
    <div class="step"><div class="step-number">2</div><span class="step-label">{{ _('step_configure') }}</span></div>
    <div class="step-line"></div>
    <div class="step"><div class="step-number">3</div><span class="step-label">{{ _('step_download') }}</span></div>
</div>
{% endblock %}

{% block content %}
<div class="card">
    <div id="uploadSection">
        <div class="drop-zone" id="dropZone">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:60px;height:60px;margin-bottom:16px;">
                <rect x="3" y="3" width="18" height="18" rx="2" stroke-width="2"/>
                <path d="M3 15l4-4 4 4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M14 10l3-3 4 4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h3>{{ _('upload_file') }}</h3>
            <p>{{ _('resize_subtitle') }}</p>
            <input type="file" id="fileInput" accept=".pdf">
        </div>
        <div class="file-info-bar" id="fileInfoBar">
            <div>
                <div class="file-name" id="fileName"></div>
                <div class="file-size" id="fileSize"></div>
            </div>
            <button class="change-btn" onclick="resetUpload()">{{ _('remove') }}</button>
        </div>
    </div>

    <div class="config-section" id="configSection">
        <div class="config-label">{{ _('resize_target_size') }}</div>
        <div class="size-grid">
            <div class="size-option active" data-size="a4" onclick="selectSize(this)">
                <div class="size-name">A4</div>
                <div class="size-dims">210 √ó 297 mm</div>
            </div>
            <div class="size-option" data-size="letter" onclick="selectSize(this)">
                <div class="size-name">Letter</div>
                <div class="size-dims">216 √ó 279 mm</div>
            </div>
            <div class="size-option" data-size="a3" onclick="selectSize(this)">
                <div class="size-name">A3</div>
                <div class="size-dims">297 √ó 420 mm</div>
            </div>
            <div class="size-option" data-size="a5" onclick="selectSize(this)">
                <div class="size-name">A5</div>
                <div class="size-dims">148 √ó 210 mm</div>
            </div>
            <div class="size-option" data-size="legal" onclick="selectSize(this)">
                <div class="size-name">Legal</div>
                <div class="size-dims">216 √ó 356 mm</div>
            </div>
        </div>

        <div class="config-label">{{ _('resize_mode') }}</div>
        <div class="mode-grid">
            <div class="mode-option active" data-mode="fit" onclick="selectMode(this)">
                <div class="mode-icon">üî≤</div>
                <div class="mode-name">{{ _('resize_mode_fit') }}</div>
                <div class="mode-desc">{{ _('resize_mode_fit_desc') }}</div>
            </div>
            <div class="mode-option" data-mode="crop" onclick="selectMode(this)">
                <div class="mode-icon">‚úÇÔ∏è</div>
                <div class="mode-name">{{ _('resize_mode_crop') }}</div>
                <div class="mode-desc">{{ _('resize_mode_crop_desc') }}</div>
            </div>
            <div class="mode-option" data-mode="expand" onclick="selectMode(this)">
                <div class="mode-icon">‚¨ú</div>
                <div class="mode-name">{{ _('resize_mode_expand') }}</div>
                <div class="mode-desc">{{ _('resize_mode_expand_desc') }}</div>
            </div>
        </div>
    </div>

    <button class="btn-primary" id="resizeBtn" disabled>{{ _('resize_btn') }}</button>

    <div class="loading-indicator" id="loadingIndicator">
        <div class="spinner"></div>
        <span>{{ _('resize_btn_loading') }}</span>
    </div>

    <div class="result" id="resultSection"></div>
</div>
{% endblock %}

{% block related_tools %}
<div id="relatedToolsContainer"></div>
{% endblock %}

{% block extra_js %}
<script>
    const steps = initSteps(document.getElementById('stepIndicator'));
    let selectedFile = null;
    let selectedSize = 'a4';
    let selectedMode = 'fit';

    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const resizeBtn = document.getElementById('resizeBtn');

    setupDropZone(dropZone, fileInput, {
        accept: '.pdf', multiple: false,
        onFiles: (files) => handleFile(files[0])
    });

    function handleFile(file) {
        if (!validatePDF(file)) return;
        selectedFile = file;
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = formatSize(file.size);
        document.getElementById('fileInfoBar').classList.add('show');
        document.getElementById('configSection').classList.add('show');
        dropZone.style.display = 'none';
        resizeBtn.disabled = false;
        steps.setStep(1);
    }

    function resetUpload() {
        selectedFile = null;
        document.getElementById('fileInfoBar').classList.remove('show');
        document.getElementById('configSection').classList.remove('show');
        dropZone.style.display = '';
        resizeBtn.disabled = true;
        document.getElementById('resultSection').className = 'result';
        document.getElementById('loadingIndicator').classList.remove('show');
        fileInput.value = '';
    }

    function selectSize(el) {
        document.querySelectorAll('.size-option').forEach(o => o.classList.remove('active'));
        el.classList.add('active');
        selectedSize = el.dataset.size;
    }

    function selectMode(el) {
        document.querySelectorAll('.mode-option').forEach(o => o.classList.remove('active'));
        el.classList.add('active');
        selectedMode = el.dataset.mode;
    }

    resizeBtn.addEventListener('click', async () => {
        if (!selectedFile) return;

        resizeBtn.disabled = true;
        resizeBtn.textContent = __('resize_btn_loading');
        document.getElementById('resultSection').className = 'result';
        document.getElementById('loadingIndicator').classList.add('show');

        const formData = new FormData();
        formData.append('pdf_file', selectedFile);
        formData.append('target_size', selectedSize);
        formData.append('mode', selectedMode);

        try {
            const data = await uploadWithProgress('/api/resize', formData);
            document.getElementById('loadingIndicator').classList.remove('show');

            if (data.success) {
                const resultDiv = document.getElementById('resultSection');
                resultDiv.className = 'result success show';
                resultDiv.innerHTML = `
                    <h3>${__('resize_complete')}</h3>
                    <p>${data.message || ''}</p>
                    ${downloadHTML(data.download_url, selectedFile.name, __('resized_suffix'))}
                `;
                resultDiv.style.display = 'block';
                showToast(__('resize_complete'), 'success');
                steps.setStep(2);
                showRelatedTools(document.getElementById('relatedToolsContainer'), 'resize');
            } else {
                throw new Error(data.error || __('error'));
            }
        } catch (error) {
            document.getElementById('loadingIndicator').classList.remove('show');
            const resultDiv = document.getElementById('resultSection');
            resultDiv.className = 'result error show';
            resultDiv.innerHTML = `<h3>${__('error')}</h3><p>${error.message}</p>`;
            resultDiv.style.display = 'block';
            showToast(error.message, 'error');
        } finally {
            resizeBtn.disabled = false;
            resizeBtn.textContent = __('resize_btn');
        }
    });
</script>
{% endblock %}
