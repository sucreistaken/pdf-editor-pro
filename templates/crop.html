{% extends 'base.html' %}

{% block title %}{% if seo %}{{ seo.title }}{% else %}{{ _('crop_title') }} - {{ site_name }}{% endif %}{% endblock %}

{% block header_icon %}‚úÇÔ∏è{% endblock %}
{% block header_title %}{{ _('crop_title') }}{% endblock %}
{% block header_subtitle %}{{ _('crop_subtitle') }}{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg, #065f46 0%, #047857 100%);
        background-size: 200% 200%;
        animation: gradientShift 15s ease infinite;
    }

    .file-info-box {
        margin-top: 20px; padding: 16px 20px;
        background: rgba(255,255,255,0.15);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 12px; display: none; color: white;
    }
    .file-info-box .file-name { font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; }
    .file-info-box .file-size { font-size: 0.85rem; color: rgba(255,255,255,0.6); }

    .mode-section { margin-top: 24px; }
    .mode-section > label { display: block; color: white; font-weight: 600; font-size: 0.95rem; margin-bottom: 12px; }

    .mode-options { display: flex; gap: 12px; margin-bottom: 20px; }
    .mode-option {
        flex: 1; padding: 16px; text-align: center;
        background: rgba(255,255,255,0.08); border: 2px solid rgba(255,255,255,0.15);
        border-radius: 14px; cursor: pointer; transition: all 0.3s; color: white;
    }
    .mode-option:hover { background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.25); }
    .mode-option.selected { background: rgba(255,255,255,0.18); border-color: rgba(255,255,255,0.5); }
    .mode-option .mode-icon { font-size: 1.5rem; margin-bottom: 8px; }
    .mode-option .mode-title { font-weight: 700; font-size: 0.95rem; margin-bottom: 4px; }
    .mode-option .mode-desc { font-size: 0.8rem; color: rgba(255,255,255,0.55); }

    .margins-grid {
        display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px;
    }
    .margin-field { display: flex; flex-direction: column; gap: 6px; }
    .margin-field label { color: rgba(255,255,255,0.8); font-size: 0.85rem; font-weight: 600; }
    .margin-field input {
        padding: 10px 14px; background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2); border-radius: 10px;
        color: white; font-size: 0.95rem; outline: none;
    }
    .margin-field input:focus { border-color: rgba(255,255,255,0.4); }

    .auto-info {
        margin-top: 16px; padding: 14px 18px;
        background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15);
        border-radius: 10px; color: rgba(255,255,255,0.8); font-size: 0.9rem;
        display: none;
    }
</style>
{% endblock %}

{% block step_indicator %}
<div class="step-indicator" id="stepIndicator">
    <div class="step active"><div class="step-number">1</div><span class="step-label">{{ _('step_upload') }}</span></div>
    <div class="step-line"></div>
    <div class="step"><div class="step-number">2</div><span class="step-label">{{ _('step_crop') }}</span></div>
    <div class="step-line"></div>
    <div class="step"><div class="step-number">3</div><span class="step-label">{{ _('step_download') }}</span></div>
</div>
{% endblock %}

{% block content %}
<div class="card">
    <div class="preview-layout">
        <div>
            <div class="drop-zone" id="dropZone">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="70" height="70">
                    <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <polyline points="14,2 14,8 20,8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 18V12M9 15l3-3 3 3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <h3>{{ _('upload_file') }}</h3>
                <p>{{ _('crop_subtitle') }}</p>
                <span class="file-limit">{{ _('upload_limit') }}</span>
                <input type="file" id="fileInput" accept=".pdf">
            </div>

            <div class="file-info-box" id="fileInfoBox">
                <div class="file-name" id="fileName"></div>
                <div class="file-size" id="fileSize"></div>
            </div>

            <div class="mode-section">
                <div class="mode-options">
                    <div class="mode-option selected" data-mode="manual" onclick="selectMode('manual')">
                        <div class="mode-icon">üìê</div>
                        <div class="mode-title">{{ _('crop_mode_manual') }}</div>
                        <div class="mode-desc">{{ _('crop_top') }}/{{ _('crop_bottom') }}/{{ _('crop_left') }}/{{ _('crop_right') }}</div>
                    </div>
                    <div class="mode-option" data-mode="auto" onclick="selectMode('auto')">
                        <div class="mode-icon">‚ú®</div>
                        <div class="mode-title">{{ _('crop_mode_auto') }}</div>
                        <div class="mode-desc">{{ _('crop_auto_desc') }}</div>
                    </div>
                </div>

                <div id="manualOptions">
                    <div class="margins-grid">
                        <div class="margin-field">
                            <label>{{ _('crop_top') }} ({{ _('crop_margin_px') }})</label>
                            <input type="number" id="marginTop" value="0" min="0" max="500">
                        </div>
                        <div class="margin-field">
                            <label>{{ _('crop_bottom') }} ({{ _('crop_margin_px') }})</label>
                            <input type="number" id="marginBottom" value="0" min="0" max="500">
                        </div>
                        <div class="margin-field">
                            <label>{{ _('crop_left') }} ({{ _('crop_margin_px') }})</label>
                            <input type="number" id="marginLeft" value="0" min="0" max="500">
                        </div>
                        <div class="margin-field">
                            <label>{{ _('crop_right') }} ({{ _('crop_margin_px') }})</label>
                            <input type="number" id="marginRight" value="0" min="0" max="500">
                        </div>
                    </div>
                </div>

                <div class="auto-info" id="autoInfo">
                    ‚ú® {{ _('crop_auto_desc') }}
                </div>
            </div>

            <button class="btn-primary" id="cropBtn" disabled>{{ _('crop_btn') }}</button>

            <div class="upload-progress" id="uploadProgress">
                <div class="progress-text" id="progressText">{{ _('uploading') }}</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>

            <div class="result" id="result"></div>
        </div>

        <div class="preview-panel" id="previewPanel" style="display:none">
            <div class="preview-panel-title">{{ _('preview') }}</div>
            <div class="preview-container" id="previewContainer" style="position:relative;">
                <div class="crop-overlay" id="cropOverlay">
                    <div class="crop-overlay-border" id="cropBorderTop"></div>
                    <div class="crop-overlay-border" id="cropBorderBottom"></div>
                    <div class="crop-overlay-border" id="cropBorderLeft"></div>
                    <div class="crop-overlay-border" id="cropBorderRight"></div>
                </div>
            </div>
            <div class="preview-nav" id="previewNav" style="display: none;">
                <button id="prevPageBtn" disabled>&lsaquo;</button>
                <span id="pageInfo">1 / 1</span>
                <button id="nextPageBtn">&rsaquo;</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block related_tools %}
<div id="relatedToolsContainer"></div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedFile = null;
    let cropMode = 'manual';
    let previewData = null;
    let totalPages = 1;
    let currentPreviewPage = 0;
    const steps = initSteps(document.getElementById('stepIndicator'));

    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const cropBtn = document.getElementById('cropBtn');
    const resultDiv = document.getElementById('result');
    const previewPanel = document.getElementById('previewPanel');
    const previewContainer = document.getElementById('previewContainer');

    setupDropZone(dropZone, fileInput, {
        accept: '.pdf',
        multiple: false,
        onFiles: (files) => handleFile(files[0])
    });

    function handleFile(file) {
        if (!validatePDF(file)) return;
        selectedFile = file;
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = formatSize(file.size);
        document.getElementById('fileInfoBox').style.display = 'block';
        cropBtn.disabled = false;
        steps.setStep(1);

        // Load preview
        currentPreviewPage = 0;
        previewPanel.style.display = '';
        loadPreview(file, previewContainer, { width: 500, onLoad: function(data) {
            previewData = { width: data.page_width || 595, height: data.page_height || 842 };
            totalPages = data.total_pages || 1;
            updateCropOverlay();
            if (totalPages > 1) {
                document.getElementById('previewNav').style.display = 'flex';
                document.getElementById('pageInfo').textContent = '1 / ' + totalPages;
                document.getElementById('prevPageBtn').disabled = true;
                document.getElementById('nextPageBtn').disabled = totalPages <= 1;
            } else {
                document.getElementById('previewNav').style.display = 'none';
            }
        }});
    }

    // Page navigation
    document.getElementById('prevPageBtn').addEventListener('click', () => {
        if (currentPreviewPage > 0) {
            currentPreviewPage--;
            navigateCropPreview();
        }
    });
    document.getElementById('nextPageBtn').addEventListener('click', () => {
        if (currentPreviewPage < totalPages - 1) {
            currentPreviewPage++;
            navigateCropPreview();
        }
    });

    function navigateCropPreview() {
        document.getElementById('prevPageBtn').disabled = currentPreviewPage === 0;
        document.getElementById('nextPageBtn').disabled = currentPreviewPage >= totalPages - 1;
        document.getElementById('pageInfo').textContent = (currentPreviewPage + 1) + ' / ' + totalPages;

        loadPreview(selectedFile, previewContainer, {
            page: currentPreviewPage,
            width: 500,
            onLoad: function(data) {
                previewData = { width: data.page_width || 595, height: data.page_height || 842 };
                updateCropOverlay();
            }
        });
    }

    function selectMode(mode) {
        cropMode = mode;
        document.querySelectorAll('.mode-option').forEach(o => o.classList.remove('selected'));
        document.querySelector(`.mode-option[data-mode="${mode}"]`).classList.add('selected');
        document.getElementById('manualOptions').style.display = mode === 'manual' ? 'block' : 'none';
        document.getElementById('autoInfo').style.display = mode === 'auto' ? 'block' : 'none';
        const overlay = previewContainer.querySelector('.crop-overlay');
        if (overlay) overlay.style.display = mode === 'manual' ? '' : 'none';
    }

    // Crop overlay logic - recreate overlay if it was removed by loadPreview
    function ensureCropOverlay() {
        let overlay = previewContainer.querySelector('.crop-overlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.className = 'crop-overlay';
            overlay.id = 'cropOverlay';
            overlay.innerHTML = `
                <div class="crop-overlay-border" id="cropBorderTop"></div>
                <div class="crop-overlay-border" id="cropBorderBottom"></div>
                <div class="crop-overlay-border" id="cropBorderLeft"></div>
                <div class="crop-overlay-border" id="cropBorderRight"></div>
            `;
            previewContainer.appendChild(overlay);
        }
        overlay.style.display = cropMode === 'manual' ? '' : 'none';
        return overlay;
    }

    function updateCropOverlay() {
        if (!previewData) return;
        const img = previewContainer.querySelector('img');
        if (!img) return;

        ensureCropOverlay();

        const top = parseInt(document.getElementById('marginTop').value) || 0;
        const bottom = parseInt(document.getElementById('marginBottom').value) || 0;
        const left = parseInt(document.getElementById('marginLeft').value) || 0;
        const right = parseInt(document.getElementById('marginRight').value) || 0;

        const cw = img.offsetWidth;
        const ch = img.offsetHeight;
        const sx = cw / previewData.width;
        const sy = ch / previewData.height;

        const tPx = top * sy;
        const bPx = bottom * sy;
        const lPx = left * sx;
        const rPx = right * sx;

        document.getElementById('cropBorderTop').style.cssText =
            `top:0;left:0;width:100%;height:${tPx}px;display:${top>0?'block':'none'}`;
        document.getElementById('cropBorderBottom').style.cssText =
            `bottom:0;left:0;width:100%;height:${bPx}px;display:${bottom>0?'block':'none'}`;
        document.getElementById('cropBorderLeft').style.cssText =
            `top:${tPx}px;left:0;width:${lPx}px;height:calc(100% - ${tPx+bPx}px);display:${left>0?'block':'none'}`;
        document.getElementById('cropBorderRight').style.cssText =
            `top:${tPx}px;right:0;width:${rPx}px;height:calc(100% - ${tPx+bPx}px);display:${right>0?'block':'none'}`;
    }

    ['marginTop','marginBottom','marginLeft','marginRight'].forEach(id => {
        document.getElementById(id).addEventListener('input', updateCropOverlay);
    });

    cropBtn.addEventListener('click', async () => {
        if (!selectedFile) return;

        cropBtn.disabled = true;
        cropBtn.classList.add('loading');
        resultDiv.className = 'result';

        const formData = new FormData();
        formData.append('pdf_file', selectedFile);
        formData.append('mode', cropMode);

        if (cropMode === 'manual') {
            formData.append('top', document.getElementById('marginTop').value);
            formData.append('bottom', document.getElementById('marginBottom').value);
            formData.append('left', document.getElementById('marginLeft').value);
            formData.append('right', document.getElementById('marginRight').value);
        }

        const uploadProgress = document.getElementById('uploadProgress');
        const progressText = document.getElementById('progressText');
        const progressFill = document.getElementById('progressFill');

        try {
            const data = await uploadWithProgress('/api/crop', formData, {
                onProgress: (percent, loaded, total) => {
                    uploadProgress.classList.add('show');
                    progressFill.style.width = percent + '%';
                    progressText.textContent = __('uploading') + ' ' + percent + '%';
                }
            });

            uploadProgress.classList.remove('show');

            if (data.success) {
                steps.setStep(2);
                resultDiv.className = 'result show';
                resultDiv.innerHTML = `
                    <h3>${__('crop_complete')}</h3>
                    <p>${data.page_count} ${__('pages')}</p>
                    <a href="${data.download_url}" class="download-btn">${__('download')}</a>
                `;
                showRelatedTools(document.getElementById('relatedToolsContainer'), 'crop');
            } else {
                throw new Error(data.error || __('error_generic'));
            }
        } catch (error) {
            uploadProgress.classList.remove('show');
            resultDiv.className = 'result error show';
            resultDiv.innerHTML = '<h3>' + __('error') + '</h3><p>' + error.message + '</p>';
        } finally {
            cropBtn.disabled = false;
            cropBtn.classList.remove('loading');
            cropBtn.textContent = __('crop_btn');
        }
    });
</script>
{% endblock %}
