{% extends 'base.html' %}

{% block title %}{% if seo %}{{ seo.title }}{% else %}{{ _('office_to_pdf_title') }} - {{ site_name }}{% endif %}{% endblock %}

{% block header_icon %}ðŸ“„{% endblock %}
{% block header_title %}{{ _('office_to_pdf_title') }}{% endblock %}
{% block header_subtitle %}{{ _('office_to_pdf_subtitle') }}{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        background-size: 200% 200%;
        animation: gradientShift 15s ease infinite;
    }

    .file-info-bar {
        margin-top: 20px; padding: 16px 20px;
        background: rgba(255,255,255,0.15); backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2); border-radius: 14px;
        display: none; align-items: center; justify-content: space-between;
    }
    .file-info-bar.show { display: flex; }
    .file-info-bar .file-name { font-weight: 600; font-size: 0.95rem; }
    .file-info-bar .file-details { display: flex; gap: 10px; align-items: center; }
    .file-info-bar .file-size { font-size: 0.85rem; color: rgba(255,255,255,0.6); }
    .file-info-bar .file-type-badge {
        padding: 3px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 700;
        text-transform: uppercase; letter-spacing: 0.05em;
    }
    .badge-word { background: rgba(30,64,175,0.4); color: #93c5fd; border: 1px solid rgba(59,130,246,0.4); }
    .badge-excel { background: rgba(16,185,129,0.3); color: #6ee7b7; border: 1px solid rgba(16,185,129,0.4); }
    .badge-ppt { background: rgba(239,68,68,0.3); color: #fca5a5; border: 1px solid rgba(239,68,68,0.4); }
    .badge-other { background: rgba(255,255,255,0.15); color: rgba(255,255,255,0.7); border: 1px solid rgba(255,255,255,0.2); }
    .file-info-bar .change-btn {
        padding: 6px 14px; background: rgba(255,255,255,0.15);
        border: 1px solid rgba(255,255,255,0.2); color: white;
        border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 600;
    }

    .supported-formats {
        margin-top: 16px; display: flex; gap: 6px; flex-wrap: wrap; justify-content: center;
    }
    .format-tag {
        padding: 4px 10px; background: rgba(255,255,255,0.08);
        border: 1px solid rgba(255,255,255,0.15); border-radius: 6px;
        font-size: 0.75rem; font-weight: 600; color: rgba(255,255,255,0.6);
    }

    .loading-indicator { display: none; text-align: center; padding: 30px; margin-top: 20px; }
    .loading-indicator.show { display: block; }
    .loading-indicator .spinner {
        width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.15);
        border-top-color: #3b82f6; border-radius: 50%;
        animation: spin 0.8s linear infinite; margin: 0 auto 14px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>
{% endblock %}

{% block step_indicator %}
<div class="step-indicator" id="stepIndicator">
    <div class="step active"><div class="step-number">1</div><span class="step-label">{{ _('step_upload') }}</span></div>
    <div class="step-line"></div>
    <div class="step"><div class="step-number">2</div><span class="step-label">{{ _('step_process') }}</span></div>
    <div class="step-line"></div>
    <div class="step"><div class="step-number">3</div><span class="step-label">{{ _('step_download') }}</span></div>
</div>
{% endblock %}

{% block content %}
<div class="card">
    <div id="uploadSection">
        <div class="drop-zone" id="dropZone">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:60px;height:60px;margin-bottom:16px;">
                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <polyline points="14 2 14 8 20 8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <line x1="12" y1="11" x2="12" y2="17" stroke-width="2" stroke-linecap="round"/>
                <polyline points="9 14 12 11 15 14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h3>{{ _('office_to_pdf_drag') }}</h3>
            <p>{{ _('office_to_pdf_subtitle') }}</p>
            <div class="supported-formats">
                <span class="format-tag">.DOCX</span>
                <span class="format-tag">.DOC</span>
                <span class="format-tag">.XLSX</span>
                <span class="format-tag">.XLS</span>
                <span class="format-tag">.PPTX</span>
                <span class="format-tag">.PPT</span>
                <span class="format-tag">.ODT</span>
                <span class="format-tag">.ODS</span>
            </div>
            <input type="file" id="fileInput" accept=".docx,.doc,.xlsx,.xls,.pptx,.ppt,.odt,.ods,.odp">
        </div>
        <div class="file-info-bar" id="fileInfoBar">
            <div>
                <div class="file-name" id="fileName"></div>
                <div class="file-details">
                    <span class="file-size" id="fileSize"></span>
                    <span class="file-type-badge" id="fileTypeBadge"></span>
                </div>
            </div>
            <button class="change-btn" onclick="resetUpload()">{{ _('remove') }}</button>
        </div>
    </div>

    <button class="btn-primary" id="convertBtn" disabled>{{ _('office_to_pdf_btn') }}</button>

    <div class="loading-indicator" id="loadingIndicator">
        <div class="spinner"></div>
        <span>{{ _('office_to_pdf_btn_loading') }}</span>
    </div>

    <div class="result" id="resultSection"></div>
</div>
{% endblock %}

{% block related_tools %}
<div id="relatedToolsContainer"></div>
{% endblock %}

{% block extra_js %}
<script>
    const steps = initSteps(document.getElementById('stepIndicator'));
    let selectedFile = null;

    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const convertBtn = document.getElementById('convertBtn');

    const FILE_TYPES = {
        'docx': { name: 'Word', badge: 'badge-word' },
        'doc': { name: 'Word', badge: 'badge-word' },
        'xlsx': { name: 'Excel', badge: 'badge-excel' },
        'xls': { name: 'Excel', badge: 'badge-excel' },
        'pptx': { name: 'PowerPoint', badge: 'badge-ppt' },
        'ppt': { name: 'PowerPoint', badge: 'badge-ppt' },
        'odt': { name: 'Writer', badge: 'badge-other' },
        'ods': { name: 'Calc', badge: 'badge-other' },
        'odp': { name: 'Impress', badge: 'badge-other' },
    };

    const ALLOWED_EXT = Object.keys(FILE_TYPES);

    setupDropZone(dropZone, fileInput, {
        accept: '.docx,.doc,.xlsx,.xls,.pptx,.ppt,.odt,.ods,.odp',
        multiple: false,
        onFiles: (files) => handleFile(files[0])
    });

    function handleFile(file) {
        const ext = file.name.split('.').pop().toLowerCase();
        if (!ALLOWED_EXT.includes(ext)) {
            showToast(__('error_invalid_file'), 'error');
            return;
        }
        selectedFile = file;
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = formatSize(file.size);

        const typeInfo = FILE_TYPES[ext] || { name: ext.toUpperCase(), badge: 'badge-other' };
        const badge = document.getElementById('fileTypeBadge');
        badge.textContent = typeInfo.name;
        badge.className = 'file-type-badge ' + typeInfo.badge;

        document.getElementById('fileInfoBar').classList.add('show');
        dropZone.style.display = 'none';
        convertBtn.disabled = false;
        steps.setStep(1);
    }

    function resetUpload() {
        selectedFile = null;
        document.getElementById('fileInfoBar').classList.remove('show');
        dropZone.style.display = '';
        convertBtn.disabled = true;
        document.getElementById('resultSection').className = 'result';
        document.getElementById('loadingIndicator').classList.remove('show');
        fileInput.value = '';
    }

    convertBtn.addEventListener('click', async () => {
        if (!selectedFile) return;

        convertBtn.disabled = true;
        convertBtn.textContent = __('office_to_pdf_btn_loading');
        document.getElementById('resultSection').className = 'result';
        document.getElementById('loadingIndicator').classList.add('show');

        const formData = new FormData();
        formData.append('office_file', selectedFile);

        try {
            const data = await uploadWithProgress('/api/office-to-pdf', formData);
            document.getElementById('loadingIndicator').classList.remove('show');

            if (data.success) {
                const resultDiv = document.getElementById('resultSection');
                resultDiv.className = 'result success show';
                resultDiv.innerHTML = `
                    <h3>${__('office_to_pdf_complete')}</h3>
                    <p>${data.message || ''}</p>
                    ${downloadHTML(data.download_url, selectedFile.name, '')}
                `;
                resultDiv.style.display = 'block';
                showToast(__('office_to_pdf_complete'), 'success');
                steps.setStep(2);
                showRelatedTools(document.getElementById('relatedToolsContainer'), 'office-to-pdf');
            } else {
                throw new Error(data.error || __('error'));
            }
        } catch (error) {
            document.getElementById('loadingIndicator').classList.remove('show');
            const resultDiv = document.getElementById('resultSection');
            resultDiv.className = 'result error show';
            resultDiv.innerHTML = `<h3>${__('error')}</h3><p>${error.message}</p>`;
            resultDiv.style.display = 'block';
            showToast(error.message, 'error');
        } finally {
            convertBtn.disabled = false;
            convertBtn.textContent = __('office_to_pdf_btn');
        }
    });
</script>
{% endblock %}
